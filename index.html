<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Test Simulator -JR</title>
    <style>
        :root {
            --aws-dark: #232f3e;
            --aws-light: #3c4d61;
            --acc: #ff9900;
            --bg: #f2f4f8;
            --white: #ffffff;
            --success: #1d8102;
            --error: #d13212;
            --text: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 20px; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
        }
        
        .app-container { 
            background: var(--white); 
            width: 100%; 
            max-width: 950px; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            position: relative;
            min-height: 600px;
        }
        
        h1, h2, h3 { color: var(--aws-dark); margin-top: 0; }
        
        /* --- TIMER --- */
        .timer-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--aws-dark);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1rem;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* PANTALLA DE INICIO (LOAD) */
        #screen-load { text-align: center; padding: 20px 0; display: block; }
        
        .found-card {
            background: #dcfce7;
            border: 2px solid var(--success);
            padding: 30px;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 600px;
            display: none; 
        }
        .found-icon { font-size: 3rem; display: block; margin-bottom: 10px; }
        .found-title { font-weight: bold; font-size: 1.2rem; color: #14532d; margin-bottom: 5px; }
        .found-info { color: #14532d; margin-bottom: 20px; }

        .file-box { 
            border: 2px dashed #ccc; 
            padding: 40px; 
            border-radius: 12px; 
            background: #fafafa; 
            margin: 20px auto; 
            max-width: 600px;
            transition: 0.3s; 
            cursor: pointer; 
            display: none; 
        }
        .file-box:hover { border-color: var(--acc); background: #fffdf5; }
        
        #loading-indicator {
            color: var(--aws-light);
            font-weight: bold;
            margin: 40px 0;
            font-size: 1.2rem;
        }

        /* PANTALLA CONFIGURACION */
        #screen-config { display: none; text-align: center; }
        .config-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            display: inline-block;
            text-align: left;
            width: 100%;
            max-width: 600px;
            border-top: 5px solid var(--aws-dark);
        }

        .mode-selection { display: flex; gap: 15px; margin: 20px 0; }
        .mode-option {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
            background: white;
            opacity: 0.7;
        }
        .mode-option:hover { border-color: #bbb; opacity: 1; }
        .mode-option.selected {
            border-color: var(--aws-dark);
            background: #f0f7ff;
            opacity: 1;
            box-shadow: 0 0 0 1px var(--aws-dark);
        }
        .mode-title { font-weight: bold; display: block; margin-bottom: 5px; color: var(--aws-dark); }
        .mode-desc { font-size: 0.85rem; color: #666; line-height: 1.4; }
        
        /* PANTALLA QUIZ */
        #screen-quiz { display: none; }
        .header-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        
        .progress-container { flex: 1; margin: 0 20px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--acc); width: 0%; transition: width 0.3s; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.single { background: #e0e7ff; color: #4338ca; }
        .badge.multi { background: #fee2e2; color: #b91c1c; }

        .question-text { font-size: 1.2rem; font-weight: 600; line-height: 1.6; margin-bottom: 30px; white-space: pre-line; }

        .options-list { display: flex; flex-direction: column; gap: 15px; }
        .opt-label { 
            display: flex; gap: 15px; padding: 18px; 
            border: 2px solid #e5e7eb; border-radius: 8px; 
            cursor: pointer; transition: all 0.2s; 
            background: white; align-items: flex-start; 
        }
        .opt-label:hover:not(.disabled) { border-color: var(--aws-dark); background: #f9fafb; }
        .opt-label.disabled { cursor: default; }
        
        .opt-label input { margin-top: 5px; transform: scale(1.3); cursor: pointer; }
        .opt-label span { flex: 1; line-height: 1.5; font-size: 1.05rem; }

        .opt-label.correct { background: #dcfce7; border-color: var(--success); color: #14532d; }
        .opt-label.incorrect { background: #fee2e2; border-color: var(--error); color: #7f1d1d; }
        .opt-label.missed { background: #f0fdf4; border-color: var(--success); border-style: dashed; }
        .opt-label.selected-exam { border-color: var(--aws-dark); background: #eef6fc; font-weight: 500; }

        .feedback-area { 
            margin-top: 30px; 
            background: #f0f7ff; 
            border-radius: 8px; 
            padding: 25px; 
            border-left: 6px solid var(--aws-dark); 
            display: none; 
            animation: fadeIn 0.4s ease; 
        }
        .feedback-title { font-weight: bold; color: var(--aws-dark); margin-bottom: 10px; display: block; }
        .feedback-content { font-size: 1rem; line-height: 1.7; white-space: pre-wrap; color: #333; }
        .feedback-content a { color: #0073bb; text-decoration: underline; font-weight: 600; }

        .action-row { margin-top: 30px; display: flex; justify-content: space-between; align-items: center; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--aws-dark); color: white; }
        .btn-primary:hover { background: #161e2d; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-check { background: var(--acc); color: white; }
        .btn-review-special { background: #17a2b8; color: white; border: 2px solid #138496; margin-right: auto; margin-left: 10px; display: inline-block; }

        .btn:disabled { background: #ccc; cursor: not-allowed; color: #666; }

        /* INPUTS DE RANGO */
        .range-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #eee;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .range-box input {
            width: 70px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }

        #screen-results { display: none; text-align: center; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 30px 0; }
        .result-card { background: #f8f9fa; padding: 20px; border-radius: 10px; border-bottom: 4px solid #ccc; }
        .stat-number { display: block; font-size: 2rem; font-weight: bold; color: #333; }
        .stat-label { font-size: 0.9rem; color: #666; text-transform: uppercase; }

        .score-circle {
            width: 150px; height: 150px; border-radius: 50%;
            background: var(--aws-dark); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: bold; margin: 0 auto 20px;
            border: 8px solid var(--acc);
        }

        .results-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
            align-items: center;
        }
        .action-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #error-msg { color: var(--error); font-weight: bold; display: none; margin-top: 15px; background: #fee2e2; padding: 10px; border-radius: 4px;}
        .hidden { display: none !important; }
        .review-banner { background: #fff3cd; color: #856404; padding: 10px; text-align: center; border-bottom: 1px solid #ffeeba; display: none; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* PANTALLA SELECCI√ìN CERTIFICACI√ìN */
        #screen-cert { text-align: center; padding: 10px 0; }
        .cert-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin: 30px auto;
            max-width: 640px;
        }
        .cert-card {
            display: flex;
            align-items: center;
            gap: 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 22px 24px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .cert-card:hover {
            border-color: var(--acc);
            box-shadow: 0 4px 16px rgba(255,153,0,0.18);
            transform: translateY(-2px);
        }
        .cert-icon {
            font-size: 2.4rem;
            width: 56px;
            text-align: center;
            flex-shrink: 0;
        }
        .cert-info { flex: 1; }
        .cert-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--aws-dark);
            margin-bottom: 4px;
        }
        .cert-level {
            font-size: 0.82rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 6px;
        }
        .cert-level.foundational { background: #dcfce7; color: #166534; }
        .cert-level.associate { background: #dbeafe; color: #1e40af; }
        .cert-desc {
            font-size: 0.88rem;
            color: #6b7280;
            line-height: 1.4;
        }
        .cert-arrow {
            font-size: 1.4rem;
            color: #9ca3af;
            transition: 0.2s;
        }
        .cert-card:hover .cert-arrow { color: var(--acc); transform: translateX(4px); }
        .cert-divider {
            border: 0;
            border-top: 1px solid #e5e7eb;
            margin: 10px auto;
            max-width: 640px;
        }
        .cert-upload-link {
            font-size: 0.9rem;
            color: #6b7280;
            text-decoration: none;
            cursor: pointer;
        }
        .cert-upload-link:hover { color: var(--aws-dark); }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="timer" class="timer-badge">00:00</div>
    <div id="review-banner" class="review-banner">MODO REVISI√ìN - Resultados Finales</div>

    <!-- PANTALLA SELECCI√ìN CERTIFICACI√ìN -->
    <div id="screen-cert">
        <h1 style="margin-bottom:4px;">Simulador AWS Pro</h1>
        <p style="color:#6b7280; margin-top:0; margin-bottom:8px;">Selecciona la certificaci√≥n que deseas practicar</p>

        <div class="cert-grid">
            <div class="cert-card" onclick="loadCertification('https://raw.githubusercontent.com/IngJulianRodriguez/SimuladorExamenAWS-/master/AWSPractitioner.json', 'AWS Certified Cloud Practitioner')">
                <div class="cert-icon">&#x2601;&#xFE0F;</div>
                <div class="cert-info">
                    <div class="cert-name">AWS Certified Cloud Practitioner</div>
                    <span class="cert-level foundational">Foundational</span>
                    <div class="cert-desc">778 preguntas sobre fundamentos de la nube AWS, servicios core y conceptos b√°sicos de facturaci√≥n y seguridad.</div>
                </div>
                <div class="cert-arrow">&#x203A;</div>
            </div>

            <div class="cert-card" onclick="loadCertification('https://raw.githubusercontent.com/IngJulianRodriguez/SimuladorExamenAWS-/master/AWSAIPractitioner.json', 'AWS Certified AI Practitioner')">
                <div class="cert-icon">&#x1F916;</div>
                <div class="cert-info">
                    <div class="cert-name">AWS Certified AI Practitioner (Proximamente)</div>
                    <span class="cert-level foundational">Foundational</span>
                    <div class="cert-desc">Conceptos de IA/ML, servicios de inteligencia artificial de AWS y uso responsable de la IA.</div>
                </div>
                <div class="cert-arrow">&#x203A;</div>
            </div>

            <div class="cert-card" onclick="loadCertification('https://raw.githubusercontent.com/IngJulianRodriguez/SimuladorExamenAWS-/master/AwsSolutionsArchitectAssociate.json', 'AWS Certified Solutions Architect - Associate')">
                <div class="cert-icon">&#x1F3D7;&#xFE0F;</div>
                <div class="cert-info">
                    <div class="cert-name">AWS Certified Solutions Architect - 390 Preguntas</div>
                    <span class="cert-level associate">Associate</span>
                    <div class="cert-desc">390 preguntas sobre dise√±o de arquitecturas escalables, seguras y de alta disponibilidad en AWS.</div>
                </div>
                <div class="cert-arrow">&#x203A;</div>
            </div>
        </div>

        <hr class="cert-divider">
        <p style="margin:16px 0 0;">
            <span class="cert-upload-link" onclick="showManualUploadDirect()">&#x1F4C2; Cargar archivo JSON propio</span>
        </p>
        <div id="manual-upload-cert" class="file-box" style="display:none; margin-top:16px;">
            <h2 style="margin-bottom:10px;">&#x1F4C2;</h2>
            <h3>Cargar archivo de preguntas (JSON)</h3>
            <p style="color:#666;">Clic o arrastra tu archivo aqu√≠.</p>
            <input type="file" id="fileInput" accept=".json" style="display:none">
        </div>
        <div id="cert-loading" style="display:none; margin:20px 0; color:var(--aws-light); font-weight:bold;">&#x1F504; Cargando preguntas...</div>
        <p id="error-msg"></p>
    </div>

    <!-- PANTALLA CARGA (legacy, oculta) -->
    <div id="screen-load" style="display:none;">
        <div id="loading-indicator"></div>
        <div id="default-found" class="found-card" style="display:none;"></div>
        <div id="manual-upload" class="file-box" style="display:none;"></div>
    </div>

    <div id="screen-config">
        <h2>Configurar Examen</h2>
        <p id="config-cert-name" style="color:#6b7280; margin-top:-10px; font-size:0.95rem;"></p>
        <div class="config-card">
            <div class="stat-row">
                <span>Preguntas totales en archivo:</span>
                <strong id="total-available" style="float:right">0</strong>
            </div>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ddd;">
            
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Rango de Selecci√≥n:</label>
			<span class="mode-desc">(Si quieres dominar un bloque de preguntas dentro del archivo)</span>
            <div class="range-box">
                <span>Desde la #</span>
                <input type="number" id="range-start" value="1" min="1">
                <span>hasta la #</span>
                <input type="number" id="range-end" value="1" min="1">
            </div>

            <label style="font-weight:bold;">Selecciona el Modo:</label>
            <div class="mode-selection">
                <div class="mode-option selected" onclick="selectMode('study')" id="mode-study">
                    <span class="mode-title">üìñ Modo Estudio</span>
                    <span class="mode-desc">Feedback inmediato. Aprende paso a paso.</span>
                </div>
                <div class="mode-option" onclick="selectMode('exam')" id="mode-exam">
                    <span class="mode-title">‚è±Ô∏è Simulacro Examen</span>
                    <span class="mode-desc">Sin ayudas. Navegaci√≥n libre. Resultados al final.</span>
                </div>
            </div>

            <label for="q-amount" style="font-weight:bold; display:block; margin-bottom:10px;">Cantidad de preguntas a responder:</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="q-amount" min="1" value="20" style="padding:10px; border-radius:4px; border:1px solid #ccc; width:80px; text-align:center;">
                <button class="btn btn-primary" onclick="startQuiz()" style="flex:1;">INICIAR</button>
            </div>
            
            <div style="margin-top: 15px; text-align: right;">
                 <a href="#" onclick="showLoadScreenFull()" style="color: #666; font-size: 0.9rem;">&#x2190; Cambiar Certificaci√≥n</a>
            </div>
        </div>
    </div>

    <div id="screen-quiz">
        <div class="header-bar">
            <div>
                <span style="color:#666; font-size:0.9rem;">Pregunta</span>
                <div style="font-size:1.5rem; font-weight:bold; color:var(--aws-dark);">
                    <span id="current-idx">1</span> <span style="font-size:1rem; color:#999;">/ <span id="total-session">0</span></span>
                </div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <span id="type-badge" class="badge single">Opci√≥n √önica</span>
        </div>

        <div class="question-text" id="q-text"></div>
        <div class="options-list" id="opt-container"></div>

        <div class="feedback-area" id="fb-area">
            <span class="feedback-title">üí° Explicaci√≥n:</span>
            <div class="feedback-content" id="fb-text"></div>
        </div>

        <div class="action-row">
            <button id="btn-prev" class="btn btn-secondary" onclick="prevQuestion()">‚¨Ö Anterior</button>
            <button id="btn-return" class="btn btn-review-special" onclick="showResultsScreen()" style="display:none;">‚Ü© Volver a Resultados</button>
            <div style="display:flex; gap:10px;">
                <button id="btn-check" class="btn btn-check" onclick="checkAnswer()">Verificar</button>
                <button id="btn-next" class="btn btn-primary hidden" onclick="nextQuestion()">Siguiente ‚û°</button>
                <button id="btn-finish-exam" class="btn btn-primary hidden" onclick="finishExam()">Finalizar üèÅ</button>
            </div>
        </div>
    </div>

    <div id="screen-results">
        <h2>Resultados</h2>
        <div class="score-circle" id="final-score">0%</div>
        <p id="final-msg" style="font-size:1.2rem; margin-bottom:30px;"></p>
        <div class="results-grid">
            <div class="result-card"><span class="stat-number" id="res-total">0</span><span class="stat-label">Total</span></div>
            <div class="result-card"><span class="stat-number" id="res-correct" style="color:var(--success)">0</span><span class="stat-label">Correctas</span></div>
            <div class="result-card"><span class="stat-number" id="res-incorrect" style="color:var(--error)">0</span><span class="stat-label">Err√≥neas</span></div>
            <div class="result-card"><span class="stat-number" id="res-time">00:00</span><span class="stat-label">Tiempo</span></div>
        </div>
        
        <div class="results-actions">
            <div class="action-group">
                <button class="btn btn-review-special" onclick="startReviewMode(false)">üîç Revisar Respuestas</button>
                <button class="btn btn-review-special" id="btn-review-missed" onclick="startReviewMode(true)" style="background-color: var(--error); border-color: #a0260d;">‚ùå Revisar Erradas</button>
            </div>
            
            <div class="action-group">
                <button class="btn btn-secondary" onclick="downloadMissedQuestions()" id="btn-download-missed">üì• Descargar Erradas</button>
                <button class="btn btn-secondary" onclick="retrySameQuiz()" style="border: 2px solid var(--aws-dark);">üîÅ Repetir misma prueba</button>
            </div>
            
            <div class="action-group">
                <button class="btn btn-primary" onclick="resetSession()">üîÑ Nueva Prueba</button>
            </div>
        </div>
    </div>
</div>

<script>
    let fullDB = [], sessionDB = [], currentIdx = 0, score = 0, currentMode = 'study';
    let timerInterval, secondsElapsed = 0;
    let reviewIndices = [];
    let lastUsedMode = 'study';

    const errorMsg = document.getElementById('error-msg');

    window.addEventListener('DOMContentLoaded', () => {
        // Mostrar pantalla de selecci√≥n de certificaci√≥n directamente
        document.getElementById('screen-cert').style.display = 'block';

        // Setup file upload en pantalla cert
        const fileInput = document.getElementById('fileInput');
        const manualUploadCert = document.getElementById('manual-upload-cert');
        if (fileInput && manualUploadCert) {
            manualUploadCert.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) processFile(e.target.files[0]);
            });
        }
    });

    function loadCertification(url, name) {
        const certLoading = document.getElementById('cert-loading');
        certLoading.style.display = 'block';
        // Deshabilitar clicks en tarjetas
        document.querySelectorAll('.cert-card').forEach(c => c.style.pointerEvents = 'none');

        fetch(url)
            .then(res => {
                if (!res.ok) throw new Error('Network error');
                return res.json();
            })
            .then(data => {
                certLoading.style.display = 'none';
                processRawData(data, name);
            })
            .catch(() => {
                certLoading.style.display = 'none';
                document.querySelectorAll('.cert-card').forEach(c => c.style.pointerEvents = '');
                errorMsg.innerText = 'Error al cargar el archivo. Verifica tu conexi√≥n a internet.';
                errorMsg.style.display = 'block';
            });
    }

    function showManualUploadDirect() {
        const box = document.getElementById('manual-upload-cert');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const quizVisible = document.getElementById('screen-quiz').style.display === 'block';
            if (!quizVisible) return;

            const btnCheck = document.getElementById('btn-check');
            const btnNext = document.getElementById('btn-next');
            const btnFinish = document.getElementById('btn-finish-exam');

            if (btnCheck && !btnCheck.classList.contains('hidden') && !btnCheck.disabled) {
                checkAnswer();
            } else if (btnNext && !btnNext.classList.contains('hidden') && !btnNext.disabled) {
                nextQuestion();
            } else if (btnFinish && !btnFinish.classList.contains('hidden') && !btnFinish.disabled) {
                finishExam();
            }
        }
    });

    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                processRawData(JSON.parse(ev.target.result), file.name.replace('.json',''));
            } catch (err) {
                errorMsg.innerText = "Error: JSON inv√°lido";
                errorMsg.style.display = 'block';
            }
        };
        reader.readAsText(file);
    }

    function processRawData(rawData, certName) {
        if (!Array.isArray(rawData)) return;
        fullDB = rawData;

        const total = fullDB.length;
        document.getElementById('total-available').innerText = total;

        const rStart = document.getElementById('range-start');
        const rEnd = document.getElementById('range-end');
        const qAmount = document.getElementById('q-amount');

        rStart.max = total;
        rEnd.max = total;
        rStart.value = 1;
        rEnd.value = total;
        qAmount.value = Math.min(20, total);

        // Mostrar nombre de certificaci√≥n en config
        const configTitle = document.getElementById('config-cert-name');
        if (configTitle) configTitle.innerText = certName || '';

        goToConfigScreen();
    }

    function goToConfigScreen() {
        document.getElementById('screen-cert').style.display = 'none';
        document.getElementById('screen-load').style.display = 'none';
        document.getElementById('screen-config').style.display = 'block';
    }

    function selectMode(mode) {
        currentMode = mode;
        lastUsedMode = mode;
        document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('selected'));
        document.getElementById(`mode-${mode}`).classList.add('selected');
    }

    function startQuiz() {
        const startIdx = parseInt(document.getElementById('range-start').value) - 1;
        const endIdx = parseInt(document.getElementById('range-end').value);
        const amount = parseInt(document.getElementById('q-amount').value);

        if (startIdx < 0 || endIdx > fullDB.length || startIdx >= endIdx) {
            return alert("Rango de preguntas inv√°lido.");
        }

        let rangeDB = fullDB.slice(startIdx, endIdx);
        
        if (amount > rangeDB.length) {
            return alert(`Solo hay ${rangeDB.length} preguntas en el rango seleccionado.`);
        }

        sessionDB = [...rangeDB].sort(() => 0.5 - Math.random()).slice(0, amount);
        
        sessionDB.forEach(q => {
            q._state = { answered: false, selectedIndices: [], isCorrect: false };
            const rawOpts = q.o || q.options;
            let correctInds = q.a || [];
            let cleanOpts = [];

            if (q.a) { cleanOpts = rawOpts; } 
            else { 
                rawOpts.forEach((opt, i) => {
                    cleanOpts.push(opt.text || opt);
                    if (opt.isCorrect) correctInds.push(i);
                });
            }

            let mapped = cleanOpts.map((txt, i) => ({ txt, originalIdx: i }));
            mapped.sort(() => 0.5 - Math.random());
            
            q._text = q.q || q.text || q.question;
            q._explanation = q.e || q.explanation || "";
            q._shuffledOpts = mapped;
            q._correctIndices = correctInds;
            
            q._originalRaw = {
                q: q.q || q.text || q.question,
                o: cleanOpts,
                a: correctInds,
                e: q.e || q.explanation || ""
            };
        });

        currentIdx = 0;
        document.getElementById('screen-config').style.display = 'none';
        document.getElementById('screen-quiz').style.display = 'block';
        document.getElementById('timer').style.display = 'block';
        document.getElementById('total-session').innerText = sessionDB.length;
        startTimer();
        loadQuestion();
    }

    function loadQuestion() {
        const actualIdx = (currentMode === 'review') ? reviewIndices[currentIdx] : currentIdx;
        const q = sessionDB[actualIdx];
        const state = q._state;
        
        const totalToDisplay = (currentMode === 'review') ? reviewIndices.length : sessionDB.length;
        document.getElementById('progress-bar').style.width = `${((currentIdx + 1) / totalToDisplay) * 100}%`;
        document.getElementById('current-idx').innerText = currentIdx + 1;
        document.getElementById('total-session').innerText = totalToDisplay;
        document.getElementById('q-text').innerText = q._text;

        const isMulti = q._correctIndices.length > 1;
        const badge = document.getElementById('type-badge');
        badge.innerText = isMulti ? 'SELECCI√ìN M√öLTIPLE' : 'OPCI√ìN √öNICA';

        const container = document.getElementById('opt-container');
        container.innerHTML = '';

        q._shuffledOpts.forEach((opt, idx) => {
            const label = document.createElement('div');
            label.className = 'opt-label';
            const input = document.createElement('input');
            input.type = isMulti ? 'checkbox' : 'radio';
            input.name = 'ans';
            
            if (state.selectedIndices.includes(idx)) input.checked = true;

            const isLocked = (currentMode === 'study' && state.answered) || currentMode === 'review';
            if (isLocked) {
                input.disabled = true;
                label.classList.add('disabled');
                const isCorrect = q._correctIndices.includes(opt.originalIdx);
                const isSelected = state.selectedIndices.includes(idx);
                if (isCorrect) label.classList.add(isSelected ? 'correct' : 'missed');
                else if (isSelected) label.classList.add('incorrect');
            }

            label.onclick = () => { if(!isLocked) input.click(); };
            input.onclick = (e) => {
                if (!isMulti) state.selectedIndices = [idx];
                else {
                    if (input.checked) state.selectedIndices.push(idx);
                    else state.selectedIndices = state.selectedIndices.filter(i => i !== idx);
                }
                e.stopPropagation();
            };

            const span = document.createElement('span');
            span.innerText = opt.txt;
            label.append(input, span);
            container.appendChild(label);
        });

        updateButtons();
    }

    function updateButtons() {
        const actualIdx = (currentMode === 'review') ? reviewIndices[currentIdx] : currentIdx;
        const q = sessionDB[actualIdx];
        const totalToDisplay = (currentMode === 'review') ? reviewIndices.length : sessionDB.length;

        document.getElementById('btn-prev').disabled = (currentIdx === 0);
        document.getElementById('btn-check').classList.toggle('hidden', currentMode !== 'study' || q._state.answered);
        
        const isLast = (currentIdx === totalToDisplay - 1);
        document.getElementById('btn-next').classList.toggle('hidden', (currentMode === 'study' && !q._state.answered) || isLast);
        document.getElementById('btn-finish-exam').classList.toggle('hidden', !isLast || (currentMode === 'study' && !q._state.answered) || currentMode === 'review');
        
        document.getElementById('btn-return').style.display = (currentMode === 'review') ? 'inline-block' : 'none';

        document.getElementById('fb-area').style.display = (currentMode === 'review' || q._state.answered) ? 'block' : 'none';
        document.getElementById('fb-text').innerText = q._explanation;
    }

    function checkAnswer() {
        if (document.querySelectorAll('input[name="ans"]:checked').length === 0) return alert("Selecciona una opci√≥n.");
        const actualIdx = (currentMode === 'review') ? reviewIndices[currentIdx] : currentIdx;
        sessionDB[actualIdx]._state.answered = true;
        loadQuestion();
    }

    function nextQuestion() { 
        currentIdx++; 
        loadQuestion(); 
        window.scrollTo(0, 0);
    }

    function prevQuestion() { 
        currentIdx--; 
        loadQuestion(); 
        window.scrollTo(0, 0);
    }

    function finishExam() {
        clearInterval(timerInterval);
        score = 0;
        sessionDB.forEach(q => {
            const selected = q._state.selectedIndices.map(i => q._shuffledOpts[i].originalIdx).sort();
            const correct = [...q._correctIndices].sort();
            const isCorrect = (JSON.stringify(selected) === JSON.stringify(correct));
            q._state.isCorrect = isCorrect; 
            if (isCorrect) score++;
        });

        showResultsScreen();
    }

    function showResultsScreen() {
        document.getElementById('screen-quiz').style.display = 'none';
        document.getElementById('screen-results').style.display = 'block';
        document.getElementById('review-banner').style.display = 'none';
        document.getElementById('timer').style.display = 'none';

        document.getElementById('final-score').innerText = Math.round((score/sessionDB.length)*100) + "%";
        document.getElementById('res-total').innerText = sessionDB.length;
        document.getElementById('res-correct').innerText = score;
        document.getElementById('res-incorrect').innerText = sessionDB.length - score;
        document.getElementById('res-time').innerText = document.getElementById('timer').innerText;

        const hasErrors = (score !== sessionDB.length);
        document.getElementById('btn-review-missed').style.display = hasErrors ? 'inline-block' : 'none';
        document.getElementById('btn-download-missed').style.display = hasErrors ? 'inline-block' : 'none';
    }

    function startReviewMode(onlyMissed) {
        reviewIndices = [];
        sessionDB.forEach((q, idx) => {
            if (!onlyMissed || (onlyMissed && !q._state.isCorrect)) {
                reviewIndices.push(idx);
            }
        });

        if (reviewIndices.length === 0) return;

        currentMode = 'review';
        currentIdx = 0;
        document.getElementById('screen-results').style.display = 'none';
        document.getElementById('screen-quiz').style.display = 'block';
        document.getElementById('review-banner').style.display = 'block';
        document.getElementById('review-banner').innerText = onlyMissed ? "MODO REVISI√ìN - SOLO ERRADAS" : "MODO REVISI√ìN - TODAS LAS RESPUESTAS";
        loadQuestion();
        window.scrollTo(0, 0);
    }

    function retrySameQuiz() {
        // Reiniciar estados de las preguntas de la sesi√≥n actual
        sessionDB.forEach(q => {
            q._state = { answered: false, selectedIndices: [], isCorrect: false };
        });
        
        currentIdx = 0;
        score = 0;
        currentMode = lastUsedMode; // Restaurar el modo (estudio o examen)
        
        document.getElementById('screen-results').style.display = 'none';
        document.getElementById('screen-quiz').style.display = 'block';
        document.getElementById('timer').style.display = 'block';
        document.getElementById('review-banner').style.display = 'none';
        
        startTimer();
        loadQuestion();
        window.scrollTo(0,0);
    }

    function downloadMissedQuestions() {
        const missed = sessionDB
            .filter(q => !q._state.isCorrect)
            .map(q => q._originalRaw);

        if (missed.length === 0) return alert("No hay preguntas erradas para descargar.");

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(missed, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "AWS_preguntas_erradas.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function resetSession() {
        // Go back to cert selection
        document.getElementById('screen-results').style.display = 'none';
        document.getElementById('screen-quiz').style.display = 'none';
        document.getElementById('screen-config').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('review-banner').style.display = 'none';
        document.getElementById('screen-cert').style.display = 'block';
        document.querySelectorAll('.cert-card').forEach(c => c.style.pointerEvents = '');
        errorMsg.style.display = 'none';
        fullDB = []; sessionDB = []; currentIdx = 0; score = 0;
        clearInterval(timerInterval);
    }

    function startTimer() {
        secondsElapsed = 0;
        timerInterval = setInterval(() => {
            secondsElapsed++;
            const m = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
            const s = (secondsElapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }
    
    function showLoadScreenFull() { resetSession(); }
</script>

</body>
</html>