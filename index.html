<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Test Simulator -JR</title>
    <style>
        :root {
            --aws-dark: #232f3e;
            --aws-light: #3c4d61;
            --acc: #ff9900;
            --bg: #f2f4f8;
            --white: #ffffff;
            --success: #1d8102;
            --error: #d13212;
            --text: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 20px; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
        }
        
        .app-container { 
            background: var(--white); 
            width: 100%; 
            max-width: 950px; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            position: relative;
            min-height: 600px;
        }
        
        h1, h2, h3 { color: var(--aws-dark); margin-top: 0; }
        
        /* --- TIMER --- */
        .timer-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--aws-dark);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1rem;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* PANTALLA DE INICIO (LOAD) */
        #screen-load { text-align: center; padding: 20px 0; display: block; }
        
        /* Caja de archivo encontrado */
        .found-card {
            background: #dcfce7;
            border: 2px solid var(--success);
            padding: 30px;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 600px;
            display: none; 
        }
        .found-icon { font-size: 3rem; display: block; margin-bottom: 10px; }
        .found-title { font-weight: bold; font-size: 1.2rem; color: #14532d; margin-bottom: 5px; }
        .found-info { color: #14532d; margin-bottom: 20px; }

        /* Caja de carga manual */
        .file-box { 
            border: 2px dashed #ccc; 
            padding: 40px; 
            border-radius: 12px; 
            background: #fafafa; 
            margin: 20px auto; 
            max-width: 600px;
            transition: 0.3s; 
            cursor: pointer; 
            display: none; 
        }
        .file-box:hover { border-color: var(--acc); background: #fffdf5; }
        
        #loading-indicator {
            color: var(--aws-light);
            font-weight: bold;
            margin: 40px 0;
            font-size: 1.2rem;
        }

        /* PANTALLA CONFIGURACION */
        #screen-config { display: none; text-align: center; }
        .config-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            display: inline-block;
            text-align: left;
            width: 100%;
            max-width: 600px;
            border-top: 5px solid var(--aws-dark);
        }

        /* SELECCI√ìN DE MODO */
        .mode-selection { display: flex; gap: 15px; margin: 20px 0; }
        .mode-option {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
            background: white;
            opacity: 0.7;
        }
        .mode-option:hover { border-color: #bbb; opacity: 1; }
        .mode-option.selected {
            border-color: var(--aws-dark);
            background: #f0f7ff;
            opacity: 1;
            box-shadow: 0 0 0 1px var(--aws-dark);
        }
        .mode-title { font-weight: bold; display: block; margin-bottom: 5px; color: var(--aws-dark); }
        .mode-desc { font-size: 0.85rem; color: #666; line-height: 1.4; }
        
        /* PANTALLA QUIZ */
        #screen-quiz { display: none; }
        .header-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        
        .progress-container { flex: 1; margin: 0 20px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--acc); width: 0%; transition: width 0.3s; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.single { background: #e0e7ff; color: #4338ca; }
        .badge.multi { background: #fee2e2; color: #b91c1c; }

        .question-text { font-size: 1.2rem; font-weight: 600; line-height: 1.6; margin-bottom: 30px; white-space: pre-line; }

        .options-list { display: flex; flex-direction: column; gap: 15px; }
        .opt-label { 
            display: flex; gap: 15px; padding: 18px; 
            border: 2px solid #e5e7eb; border-radius: 8px; 
            cursor: pointer; transition: all 0.2s; 
            background: white; align-items: flex-start; 
        }
        .opt-label:hover:not(.disabled) { border-color: var(--aws-dark); background: #f9fafb; }
        .opt-label.disabled { cursor: default; }
        
        .opt-label input { margin-top: 5px; transform: scale(1.3); cursor: pointer; }
        .opt-label.disabled input { cursor: default; }
        .opt-label span { flex: 1; line-height: 1.5; font-size: 1.05rem; }

        /* ESTADOS */
        .opt-label.correct { background: #dcfce7; border-color: var(--success); color: #14532d; }
        .opt-label.incorrect { background: #fee2e2; border-color: var(--error); color: #7f1d1d; }
        .opt-label.missed { background: #f0fdf4; border-color: var(--success); border-style: dashed; }
        .opt-label.selected-exam { border-color: var(--aws-dark); background: #eef6fc; font-weight: 500; }

        /* FEEDBACK */
        .feedback-area { 
            margin-top: 30px; 
            background: #f0f7ff; 
            border-radius: 8px; 
            padding: 25px; 
            border-left: 6px solid var(--aws-dark); 
            display: none; 
            animation: fadeIn 0.4s ease; 
        }
        .feedback-title { font-weight: bold; color: var(--aws-dark); margin-bottom: 10px; display: block; }
        .feedback-content { font-size: 1rem; line-height: 1.7; white-space: pre-wrap; color: #333; }
        .feedback-content a { color: #0073bb; text-decoration: underline; font-weight: 600; }
        .feedback-content a:hover { color: #005b96; }

        /* BOTONES */
        .action-row { margin-top: 30px; display: flex; justify-content: space-between; align-items: center; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--aws-dark); color: white; }
        .btn-primary:hover { background: #161e2d; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-check { background: var(--acc); color: white; }
        .btn-check:hover { background: #e08b00; }
        
        /* Bot√≥n Revisi√≥n Especial */
        .btn-review-special { 
            background: #17a2b8; color: white; border: 2px solid #138496;
            margin-right: auto; 
            margin-left: 10px;
            display: inline-block;
        }
        .btn-review-special:hover { background: #138496; }

        .btn:disabled { background: #ccc; cursor: not-allowed; color: #666; }

        /* RESULTADOS */
        #screen-results { display: none; text-align: center; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 30px 0; }
        .result-card { background: #f8f9fa; padding: 20px; border-radius: 10px; border-bottom: 4px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .result-card.score { border-color: var(--aws-dark); }
        .result-card.correct { border-color: var(--success); }
        .result-card.incorrect { border-color: var(--error); }
        .result-card.time { border-color: var(--acc); }
        
        .stat-number { display: block; font-size: 2rem; font-weight: bold; color: #333; }
        .stat-label { font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }

        .score-circle {
            width: 150px; height: 150px; border-radius: 50%;
            background: var(--aws-dark); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: bold; margin: 0 auto 20px;
            border: 8px solid var(--acc);
        }

        #error-msg { color: var(--error); font-weight: bold; display: none; margin-top: 15px; background: #fee2e2; padding: 10px; border-radius: 4px;}
        .hidden { display: none !important; }
        .review-banner { background: #fff3cd; color: #856404; padding: 10px; text-align: center; border-bottom: 1px solid #ffeeba; display: none; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="timer" class="timer-badge">00:00</div>
    <div id="review-banner" class="review-banner">MODO REVISI√ìN - Resultados Finales</div>

    <div id="screen-load">
        <h1>Simulador AWS Pro</h1>
        <div id="loading-indicator">üîÑ Buscando Archivo de preguntas...</div>
        
        <div id="default-found" class="found-card">
            <span class="found-icon">‚úÖ</span>
            <div class="found-title">Archivo Detectado</div>
            <div class="found-info">Preguntas para examen: <strong>AWSPractitioner</strong></div>
            
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="btn btn-primary" onclick="confirmDefault()">Siguiente ‚û°</button>
                <button class="btn btn-secondary" onclick="showManualUpload()">Cargar otro archivo</button>
            </div>
        </div>

        <div id="manual-upload" class="file-box">
            <h2 style="margin-bottom:10px;">üìÇ</h2>
            <h3>Cargar archivo de preguntas (JSON)</h3>
            <p style="color:#666;">No se detect√≥ archivo por defecto.<br>Clic o arrastra tu archivo aqu√≠.</p>
            <input type="file" id="fileInput" accept=".json" style="display:none">
        </div>

        <p id="error-msg"></p>
    </div>

    <div id="screen-config">
        <h2>Configurar Examen</h2>
        <div class="config-card">
            <div class="stat-row">
                <span>Preguntas disponibles:</span>
                <strong id="total-available" style="float:right">0</strong>
            </div>
            <div id="dup-alert" style="display:none; color: var(--error); margin-top:5px; font-size:0.9rem;">
                ‚ö†Ô∏è Se eliminaron <span id="dup-count">0</span> duplicados. 
                <a href="#" onclick="downloadCleanDB()" style="color:var(--aws-dark); margin-left:10px;">[Descargar Limpio]</a>
            </div>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ddd;">
            
            <label style="font-weight:bold;">Selecciona el Modo:</label>
            <div class="mode-selection">
                <div class="mode-option selected" onclick="selectMode('study')" id="mode-study">
                    <span class="mode-title">üìñ Modo Estudio</span>
                    <span class="mode-desc">Feedback inmediato. Aprende paso a paso.</span>
                </div>
                <div class="mode-option" onclick="selectMode('exam')" id="mode-exam">
                    <span class="mode-title">‚è±Ô∏è Simulacro Examen</span>
                    <span class="mode-desc">Sin ayudas. Navegaci√≥n libre. Resultados al final.</span>
                </div>
            </div>

            <label for="q-amount" style="font-weight:bold; display:block; margin-bottom:10px;">Cantidad de preguntas:</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="q-amount" min="1" value="20" style="padding:10px; border-radius:4px; border:1px solid #ccc; width:80px; text-align:center;">
                <button class="btn btn-primary" onclick="startQuiz()" style="flex:1;">INICIAR</button>
            </div>
            
            <div style="margin-top: 15px; text-align: right;">
                 <a href="#" onclick="showLoadScreenFull()" style="color: #666; font-size: 0.9rem;">üìÇ Cambiar Archivo</a>
            </div>
        </div>
    </div>

    <div id="screen-quiz">
        <div class="header-bar">
            <div>
                <span style="color:#666; font-size:0.9rem;">Pregunta</span>
                <div style="font-size:1.5rem; font-weight:bold; color:var(--aws-dark);">
                    <span id="current-idx">1</span> <span style="font-size:1rem; color:#999;">/ <span id="total-session">0</span></span>
                </div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <span id="type-badge" class="badge single">Opci√≥n √önica</span>
        </div>

        <div class="question-text" id="q-text"></div>
        <div class="options-list" id="opt-container"></div>

        <div class="feedback-area" id="fb-area">
            <span class="feedback-title">üí° Explicaci√≥n:</span>
            <div class="feedback-content" id="fb-text"></div>
        </div>

        <div class="action-row">
            <button id="btn-prev" class="btn btn-secondary" onclick="prevQuestion()">‚¨Ö Anterior</button>
            
            <button id="btn-return" class="btn btn-review-special" onclick="finishExam()" style="display:none;">‚Ü© Volver a Resultados</button>
            
            <div style="display:flex; gap:10px;">
                <button id="btn-check" class="btn btn-check" onclick="checkAnswer()">Verificar</button>
                <button id="btn-next" class="btn btn-primary hidden" onclick="nextQuestion()">Siguiente ‚û°</button>
                <button id="btn-finish-exam" class="btn btn-primary hidden" onclick="finishExam()">Finalizar Examen üèÅ</button>
            </div>
        </div>
    </div>

    <div id="screen-results">
        <h2>Resultados del Simulacro</h2>
        <div class="score-circle" id="final-score">0%</div>
        <p id="final-msg" style="font-size:1.2rem; margin-bottom:30px;"></p>

        <div class="results-grid">
            <div class="result-card score">
                <span class="stat-number" id="res-total">0</span><span class="stat-label">Total</span>
            </div>
            <div class="result-card correct">
                <span class="stat-number" id="res-correct" style="color:var(--success)">0</span><span class="stat-label">Correctas</span>
            </div>
            <div class="result-card incorrect">
                <span class="stat-number" id="res-incorrect" style="color:var(--error)">0</span><span class="stat-label">Incorrectas</span>
            </div>
            <div class="result-card time">
                <span class="stat-number" id="res-time">00:00</span><span class="stat-label">Tiempo</span>
            </div>
        </div>

        <div style="margin-top:30px; display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
            <button class="btn btn-review-special" onclick="startReviewMode()" style="margin:0;">üîç Revisar Respuestas</button>
            <button class="btn btn-primary" onclick="resetSession()">üîÑ Nueva Prueba</button>
            <button class="btn btn-secondary" onclick="showLoadScreenFull()">üìÇ Cargar Otro</button>
        </div>
    </div>

</div>

<script>
    // CONFIG: NOMBRE DEL ARCHIVO EN TU REPOSITORIO
    const DEFAULT_DB_PATH = 'AWSPractitioner.json';

    let fullDB = [], sessionDB = [], currentIdx = 0, score = 0, currentMode = 'study';
    let timerInterval, secondsElapsed = 0;

    const fileInput = document.getElementById('fileInput');
    const errorMsg = document.getElementById('error-msg');
    const loadingIndicator = document.getElementById('loading-indicator');
    const defaultFoundCard = document.getElementById('default-found');
    const manualUploadBox = document.getElementById('manual-upload');

    // --- INICIO ---
    window.addEventListener('DOMContentLoaded', () => {
        tryLoadDefaultDB();
    });

    function tryLoadDefaultDB() {
        loadingIndicator.style.display = 'block';
        manualUploadBox.style.display = 'none';
        defaultFoundCard.style.display = 'none';

        fetch(DEFAULT_DB_PATH)
            .then(response => {
                if (!response.ok) throw new Error("No encontrado");
                return response.json();
            })
            .then(data => {
                loadingIndicator.style.display = 'none';
                processRawData(data, true); // true = carga autom√°tica
            })
            .catch(err => {
                loadingIndicator.style.display = 'none';
                console.log("No se carg√≥ banco por defecto, mostrando manual.");
                showManualUpload();
            });
    }

    function showManualUpload() {
        defaultFoundCard.style.display = 'none';
        manualUploadBox.style.display = 'block';
        // CR√çTICO: Limpiar el input para permitir re-seleccionar el mismo archivo si hubo error antes
        fileInput.value = ''; 
    }

    // --- MANEJO DE ARCHIVOS MANUALES ---
    
    // Configurar clic en el √°rea de drop
    manualUploadBox.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => { 
        if(e.target.files.length) processFile(e.target.files[0]); 
    });
    
    // Drag & Drop
    ['dragover', 'dragleave', 'drop'].forEach(eventName => {
        manualUploadBox.addEventListener(eventName, e => { 
            e.preventDefault(); 
            e.stopPropagation(); 
        }, false);
    });
    
    manualUploadBox.addEventListener('drop', (e) => { 
        if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]); 
    });

    function processFile(file) {
        errorMsg.style.display = 'none';
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const text = ev.target.result;
                if (!text.trim()) throw new Error("Archivo vac√≠o.");
                let rawData = JSON.parse(text);
                // false = carga manual, ir directo a config
                processRawData(rawData, false); 
            } catch (err) {
                errorMsg.innerText = "Error: " + err.message;
                errorMsg.style.display = 'block';
            }
        };
        reader.readAsText(file);
    }

    // Procesar datos JSON
    function processRawData(rawData, isAutoLoad) {
        try {
            if (!Array.isArray(rawData)) throw new Error("JSON inv√°lido (debe ser un array).");

            const uniqueMap = new Map();
            let dups = 0;
            rawData.forEach(q => {
                const txt = (q.q || q.text || q.question || "").trim();
                if (txt) uniqueMap.has(txt) ? dups++ : uniqueMap.set(txt, q);
            });

            fullDB = Array.from(uniqueMap.values());
            if (fullDB.length === 0) throw new Error("Sin preguntas v√°lidas.");

            // GUARDAR DATOS Y CONFIGURAR UI
            document.getElementById('total-available').innerText = fullDB.length;
            
            if (dups > 0) {
                document.getElementById('dup-alert').style.display = 'block';
                document.getElementById('dup-count').innerText = dups;
            } else {
                document.getElementById('dup-alert').style.display = 'none';
            }

            const input = document.getElementById('q-amount');
            input.max = fullDB.length;
            input.value = Math.min(20, fullDB.length);

            // DECISI√ìN DE FLUJO
            if (isAutoLoad) {
                document.getElementById('found-count').innerText = fullDB.length;
                defaultFoundCard.style.display = 'block';
                manualUploadBox.style.display = 'none';
            } else {
                goToConfigScreen();
            }

        } catch (err) {
            errorMsg.innerText = "Error: " + err.message;
            errorMsg.style.display = 'block';
            showManualUpload();
        }
    }

    // Navegaci√≥n entre pantallas
    function confirmDefault() {
        goToConfigScreen();
    }

    function goToConfigScreen() {
        document.getElementById('screen-load').style.display = 'none';
        document.getElementById('screen-config').style.display = 'block';
    }

    function showLoadScreenFull() {
        stopTimer();
        fullDB = [];
        document.getElementById('screen-config').style.display = 'none';
        document.getElementById('screen-results').style.display = 'none';
        document.getElementById('screen-quiz').style.display = 'none';
        
        document.getElementById('screen-load').style.display = 'block';
        document.getElementById('error-msg').style.display = 'none';
        
        showManualUpload();
    }

    function downloadCleanDB() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fullDB, null, 2));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "banco_aws_limpio.json"; a.click();
    }

    function selectMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('selected'));
        document.getElementById(`mode-${mode}`).classList.add('selected');
    }

    function startQuiz() {
        const amount = parseInt(document.getElementById('q-amount').value);
        if (amount < 1 || amount > fullDB.length) return alert("Cantidad inv√°lida.");

        sessionDB = [...fullDB].sort(() => 0.5 - Math.random()).slice(0, amount);
        sessionDB.forEach(q => {
            q._state = { answered: false, selectedIndices: [], isCorrect: false };
            
            const qText = q.q || q.text || q.question;
            const explanation = q.e || q.explanation || "";
            let rawOpts = q.o || q.options;
            let correctInds = [];
            let cleanOpts = [];

            if (q.a) { 
                correctInds = q.a;
                cleanOpts = rawOpts;
            } else { 
                rawOpts.forEach((opt, i) => {
                    cleanOpts.push(opt.text || opt);
                    if (opt.isCorrect) correctInds.push(i);
                });
            }

            let mapped = cleanOpts.map((txt, i) => ({ txt, originalIdx: i }));
            mapped.sort(() => 0.5 - Math.random());
            
            q._text = qText;
            q._explanation = explanation;
            q._shuffledOpts = mapped;
            q._correctIndices = correctInds;
        });

        currentIdx = 0;
        score = 0;
        secondsElapsed = 0;
        
        document.getElementById('screen-config').style.display = 'none';
        document.getElementById('screen-quiz').style.display = 'block';
        document.getElementById('timer').style.display = 'block';
        document.getElementById('total-session').innerText = sessionDB.length;
        document.getElementById('review-banner').style.display = 'none';

        startTimer();
        loadQuestion();
    }

    function loadQuestion() {
        const q = sessionDB[currentIdx];
        const state = q._state;
        
        const progress = ((currentIdx) / sessionDB.length) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('current-idx').innerText = currentIdx + 1;
        document.getElementById('q-text').innerText = q._text;

        const isMulti = q._correctIndices.length > 1;
        const badge = document.getElementById('type-badge');
        badge.className = isMulti ? 'badge multi' : 'badge single';
        badge.innerText = isMulti ? 'SELECCI√ìN M√öLTIPLE' : 'OPCI√ìN √öNICA';

        const container = document.getElementById('opt-container');
        container.innerHTML = '';

        q._shuffledOpts.forEach((opt, idx) => {
            const label = document.createElement('div');
            label.className = 'opt-label';
            const input = document.createElement('input');
            input.type = isMulti ? 'checkbox' : 'radio';
            input.name = 'ans';
            input.value = idx;
            
            if (state.selectedIndices.includes(idx)) {
                input.checked = true;
                if (currentMode === 'exam') label.classList.add('selected-exam');
            }

            const shouldShowValidation = (currentMode === 'study' && state.answered) || currentMode === 'review';
            const isInputDisabled = shouldShowValidation || (currentMode === 'review');

            if (isInputDisabled) {
                input.disabled = true;
                label.classList.add('disabled');
            }

            if (shouldShowValidation) {
                const realIdx = opt.originalIdx;
                const isCorrect = q._correctIndices.includes(realIdx);
                const isSelected = state.selectedIndices.includes(idx);

                if (isCorrect) {
                    if (isSelected) label.classList.add('correct');
                    else label.classList.add('missed');
                } else if (isSelected) {
                    label.classList.add('incorrect');
                }
            }

            if (!isInputDisabled) {
                label.onclick = (e) => { if(e.target !== input) input.click(); };
                input.onclick = (e) => {
                    if (!isMulti) {
                        state.selectedIndices = [idx];
                        container.querySelectorAll('.opt-label').forEach(l => l.classList.remove('selected-exam'));
                    } else {
                        if (input.checked) state.selectedIndices.push(idx);
                        else state.selectedIndices = state.selectedIndices.filter(i => i !== idx);
                    }
                    if (currentMode === 'exam') {
                        if(input.checked) label.classList.add('selected-exam');
                        else label.classList.remove('selected-exam');
                    }
                    e.stopPropagation();
                };
            }

            const span = document.createElement('span');
            span.innerText = opt.txt;
            label.appendChild(input);
            label.appendChild(span);
            container.appendChild(label);
        });

        // ==========================================
        // GESTI√ìN DE BOTONES
        // ==========================================
        document.getElementById('btn-prev').disabled = (currentIdx === 0);
        
        const btnCheck = document.getElementById('btn-check');
        const btnNext = document.getElementById('btn-next');
        const btnFinish = document.getElementById('btn-finish-exam');
        const btnReturn = document.getElementById('btn-return'); 
        const fbArea = document.getElementById('fb-area');
        
        // 1. ESTADO INICIAL
        btnCheck.classList.add('hidden');
        btnNext.classList.add('hidden');
        btnFinish.classList.add('hidden');
        fbArea.style.display = 'none';
        btnReturn.style.display = 'none';

        // 2. L√≥gica seg√∫n el modo
        if (currentMode === 'study') {
            if (state.answered) {
                fbArea.style.display = 'block';
                document.getElementById('fb-text').innerHTML = linkify(q._explanation);
                
                if (currentIdx === sessionDB.length - 1) {
                    btnFinish.classList.remove('hidden');
                } else {
                    btnNext.classList.remove('hidden');
                }
            } else {
                btnCheck.classList.remove('hidden');
            }

        } else if (currentMode === 'exam') {
            if (currentIdx < sessionDB.length - 1) {
                btnNext.classList.remove('hidden');
            } else {
                btnFinish.classList.remove('hidden');
            }

        } else if (currentMode === 'review') {
            fbArea.style.display = 'block';
            document.getElementById('fb-text').innerHTML = linkify(q._explanation);
            btnReturn.style.display = 'inline-block'; 
            if (currentIdx < sessionDB.length - 1) {
                btnNext.classList.remove('hidden');
            }
        }
    }

    function checkAnswer() {
        const q = sessionDB[currentIdx];
        const inputs = document.querySelectorAll('input[name="ans"]:checked');
        if (inputs.length === 0) return alert("Selecciona una respuesta.");

        if (currentMode === 'study') {
            const selectedIdxs = Array.from(inputs).map(i => parseInt(i.value));
            q._state.selectedIndices = selectedIdxs;
            q._state.answered = true;
            
            let allCorrect = true;
            selectedIdxs.forEach(sIdx => {
                if (!q._correctIndices.includes(q._shuffledOpts[sIdx].originalIdx)) allCorrect = false;
            });
            if (selectedIdxs.length !== q._correctIndices.length) allCorrect = false;
            
            if (allCorrect) q._state.isCorrect = true;

            loadQuestion();
        }
    }

    function nextQuestion() {
        if (currentMode === 'exam' && sessionDB[currentIdx]._state.selectedIndices.length === 0) {
             if(!confirm("No has seleccionado ninguna respuesta. ¬øContinuar?")) return;
        }
        if (currentIdx < sessionDB.length - 1) {
            currentIdx++;
            loadQuestion();
        }
    }

    function prevQuestion() {
        if (currentIdx > 0) {
            currentIdx--;
            loadQuestion();
        }
    }

    function finishExam() {
        if (currentMode === 'review') {
            document.getElementById('screen-quiz').style.display = 'none';
            document.getElementById('screen-results').style.display = 'block';
            return;
        }

        stopTimer();
        score = 0;
        sessionDB.forEach(q => {
            const selected = q._state.selectedIndices;
            const correct = q._correctIndices;
            if (selected.length === correct.length) {
                const selectedOriginals = selected.map(visIdx => q._shuffledOpts[visIdx].originalIdx);
                const allMatch = selectedOriginals.every(val => correct.includes(val));
                if (allMatch) {
                    score++;
                    q._state.isCorrect = true;
                }
            }
        });

        document.getElementById('screen-quiz').style.display = 'none';
        document.getElementById('screen-results').style.display = 'block';
        document.getElementById('timer').style.display = 'none';

        const total = sessionDB.length;
        const percentage = Math.round((score / total) * 100);
        
        document.getElementById('final-score').innerText = percentage + "%";
        document.getElementById('res-total').innerText = total;
        document.getElementById('res-correct').innerText = score;
        document.getElementById('res-incorrect').innerText = total - score;
        document.getElementById('res-time').innerText = document.getElementById('timer').innerText;

        const msg = document.getElementById('final-msg');
        if (percentage >= 70) {
            msg.innerHTML = `<span style="color:var(--success)">¬°Felicidades! Aprobaste.</span>`;
            document.getElementById('final-score').style.borderColor = 'var(--success)';
        } else {
            msg.innerHTML = `<span style="color:var(--error)">No Aprobado. Meta: 70%.</span>`;
            document.getElementById('final-score').style.borderColor = 'var(--error)';
        }
    }

    function startReviewMode() {
        currentMode = 'review';
        currentIdx = 0;
        document.getElementById('screen-results').style.display = 'none';
        document.getElementById('screen-quiz').style.display = 'block';
        document.getElementById('review-banner').style.display = 'block';
        loadQuestion();
    }

    function resetSession() {
        stopTimer();
        score = 0;
        currentIdx = 0;
        secondsElapsed = 0;
        currentMode = 'study'; 
        selectMode('study');
        document.getElementById('screen-results').style.display = 'none';
        document.getElementById('screen-config').style.display = 'block';
    }

    function startTimer() {
        clearInterval(timerInterval);
        secondsElapsed = 0;
        document.getElementById('timer').innerText = "00:00";
        timerInterval = setInterval(() => {
            secondsElapsed++;
            const mins = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
            const secs = (secondsElapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${mins}:${secs}`;
        }, 1000);
    }

    function stopTimer() { clearInterval(timerInterval); }

    function linkify(text) {
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    }
</script>

</body>
</html>